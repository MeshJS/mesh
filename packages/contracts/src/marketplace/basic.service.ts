import {
  IFetcher, IInitiator, ISigner, ISubmitter,
  parseAssetUnit, resolveDataHash, resolveEpochNo,
  resolvePaymentKeyHash, resolvePlutusScriptAddress,
  Transaction,
} from "@meshsdk/core";
import type { Network, PlutusScript, UTxO } from '@meshsdk/core';

export class BasicMarketplace {
  private _fetcher: IFetcher;
  private _initiator: IInitiator;
  private _network: Network;
  private _script: PlutusScript;
  private _signer: ISigner;
  private _submitter: ISubmitter;

  constructor(options = {} as CreateMarketplaceOptions) {
    this._fetcher = options.fetcher;
    this._initiator = options.initiator;
    this._network = options.network;
    this._script = buildPlutusScript(options.owner, options.version);
    this._signer = options.signer;
    this._submitter = options.submitter;
  }

  async delistAsset(address: string, asset: string, price: string) {
    const { policyId, assetName } = parseAssetUnit(asset);
    const tx = await this.buildTx();

    const datum = {
      alternative: 0,
      fields: [
        resolvePaymentKeyHash(address),
        price, policyId, assetName,
      ],
    };

    const redeemer = {
      data: {
        alternative: 1,
        fields: []
      }
    };

    const assetUTxO = await this.findUTxO(
      resolvePlutusScriptAddress(this._script, this._network === 'mainnet' ? 1 : 0),
      asset, resolveDataHash(datum),
    );

    tx
      .redeemValue({
        value: assetUTxO,
        script: this._script,
        datum, redeemer,
      })
      .sendValue(address, assetUTxO)
      .setRequiredSigners([address]);

    const unsignedTx = await tx.build();
    const signedTx = await this._signer.signTx(unsignedTx, true);
    return this._submitter.submitTx(signedTx);
  }

  async listAsset(address: string, asset: string, price: string) {
    const { policyId, assetName } = parseAssetUnit(asset);
    const tx = await this.buildTx();

    const datum = {
      alternative: 0,
      fields: [
        resolvePaymentKeyHash(address),
        price, policyId, assetName,
      ],
    };

    tx.sendAssets(
      {
        address: resolvePlutusScriptAddress(this._script, this._network === 'mainnet' ? 1 : 0),
        datum: { value: datum },
      },
      [
        {
          unit: asset,
          quantity: '1',
        },
      ]
    );

    const unsignedTx = await tx.build();
    const signedTx = await this._signer.signTx(unsignedTx, false);
    return this._submitter.submitTx(signedTx);
  }

  async purchaseAsset(address: string, asset: string, price: string) {
    const { policyId, assetName } = parseAssetUnit(asset);
    const tx = await this.buildTx();

    const datum = {
      alternative: 0,
      fields: [
        resolvePaymentKeyHash(address),
        price, policyId, assetName,
      ],
    };

    const redeemer = {
      data: {
        alternative: 0,
        fields: []
      }
    };

    const assetUTxO = await this.findUTxO(
      resolvePlutusScriptAddress(this._script, this._network === 'mainnet' ? 1 : 0),
      asset, resolveDataHash(datum),
    );

    tx
      .redeemValue({
        value: assetUTxO,
        script: this._script,
        datum, redeemer,
      })
      .sendValue(this._initiator.getUsedAddress().to_bech32(), assetUTxO)
      .sendLovelace(address, price)

    const unsignedTx = await tx.build();
    const signedTx = await this._signer.signTx(unsignedTx, true);
    return this._submitter.submitTx(signedTx);
  }

  async relistAsset(address: string, asset: string, oldPrice: string, newPrice: string) {
    const { policyId, assetName } = parseAssetUnit(asset);
    const tx = await this.buildTx();

    const datum = {
      alternative: 0,
      fields: [
        resolvePaymentKeyHash(address),
        oldPrice, policyId, assetName,
      ],
    };

    const redeemer = {
      data: {
        alternative: 1,
        fields: []
      }
    };

    const assetUTxO = await this.findUTxO(
      resolvePlutusScriptAddress(this._script, this._network === 'mainnet' ? 1 : 0),
      asset, resolveDataHash(datum),
    );

    tx
      .redeemValue({
        value: assetUTxO,
        script: this._script,
        datum, redeemer,
      })
      .sendAssets(
        {
          address: resolvePlutusScriptAddress(this._script, this._network === 'mainnet' ? 1 : 0),
          datum: {
            value: {
              alternative: 0,
              fields: [
                resolvePaymentKeyHash(address),
                newPrice, policyId, assetName,
              ],
            }
          },
        },
        [
          {
            unit: asset,
            quantity: '1',
          },
        ]
      )
      .setRequiredSigners([address]);

    const unsignedTx = await tx.build();
    const signedTx = await this._signer.signTx(unsignedTx, true);
    return this._submitter.submitTx(signedTx);
  }

  private async buildTx() {
    const epoch = resolveEpochNo(this._network);
    const parameters = await this._fetcher.fetchProtocolParameters(epoch);

    return new Transaction({
      initiator: this._initiator,
      parameters,
    });
  }

  private async findUTxO(address: string, assetId: string, dataHash: string) {
    const utxos = await this._fetcher.fetchAddressUTxOs(
      address,
      assetId,
    );

    if (utxos.length === 0) {
      throw new Error(`No listing found for asset with Id: ${assetId}`);
    }

    const utxo: UTxO | undefined = utxos.find(
      (utxo) => utxo.output.dataHash === dataHash
    );

    if (utxo === undefined) {
      throw new Error(`No listing found for asset with Hash: ${dataHash}`);
    }

    return utxo;
  }
}

const buildPlutusScript = (owner: OwnerAddress, version: ScriptVersion): PlutusScript => ({
  V1: {
    version: 'V2' as const,
    code: `590e9b590e9801000033232323232323232323232323233223232323232223232323223223232533533300b3333573466e1cd55cea804a400046666444424666600200a0080060046eb8d5d0a8049bad35742a0106eb8d5d0a8039bae357426ae89401c8c98c8078cd5ce00f80f00e1999ab9a3370ea0089001109100091999ab9a3370ea00a9000109100111931900f99ab9c02001f01d01c3333573466e1cd55cea80124000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd406c070d5d0a80619a80d80e1aba1500b33501b01d35742a014666aa03eeb94078d5d0a804999aa80fbae501e35742a01066a03604c6ae85401cccd5407c09dd69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd40c5d69aba150023032357426ae8940088c98c80d0cd5ce01a81a01909aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a818bad35742a00460646ae84d5d1280111931901a19ab9c035034032135573ca00226ea8004d5d09aba2500223263203033573806206005c26aae7940044dd50009aba1500533501b75c6ae854010ccd5407c08c8004d5d0a801999aa80fbae200135742a004604a6ae84d5d1280111931901619ab9c02d02c02a135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a004602a6ae84d5d1280111931900f19ab9c01f01e01c101d13263201d335738921035054350001d135573ca00226ea80044d55ce9baa001135744a00226ae8940044d55cf280089baa0011232230023758002640026aa028446666aae7c004940288cd4024c010d5d080118019aba2002014232323333573466e1cd55cea8012400046644246600200600460186ae854008c014d5d09aba2500223263201433573802a02802426aae7940044dd50009191919191999ab9a3370e6aae75401120002333322221233330010050040030023232323333573466e1cd55cea80124000466442466002006004602a6ae854008cd403c050d5d09aba2500223263201933573803403202e26aae7940044dd50009aba150043335500875ca00e6ae85400cc8c8c8cccd5cd19b875001480108c84888c008010d5d09aab9e500323333573466e1d4009200223212223001004375c6ae84d55cf280211999ab9a3370ea00690001091100191931900d99ab9c01c01b019018017135573aa00226ea8004d5d0a80119a805bae357426ae8940088c98c8054cd5ce00b00a80989aba25001135744a00226aae7940044dd5000899aa800bae75a224464460046eac004c8004d5404488c8cccd55cf80112804119a8039991091980080180118031aab9d5002300535573ca00460086ae8800c0484d5d080088910010910911980080200189119191999ab9a3370ea0029000119091180100198029aba135573ca00646666ae68cdc3a801240044244002464c6402066ae700440400380344d55cea80089baa001232323333573466e1d400520062321222230040053007357426aae79400c8cccd5cd19b875002480108c848888c008014c024d5d09aab9e500423333573466e1d400d20022321222230010053007357426aae7940148cccd5cd19b875004480008c848888c00c014dd71aba135573ca00c464c6402066ae7004404003803403002c4d55cea80089baa001232323333573466e1cd55cea80124000466442466002006004600a6ae854008dd69aba135744a004464c6401866ae700340300284d55cf280089baa0012323333573466e1cd55cea800a400046eb8d5d09aab9e500223263200a33573801601401026ea80048c8c8c8c8c8cccd5cd19b8750014803084888888800c8cccd5cd19b875002480288488888880108cccd5cd19b875003480208cc8848888888cc004024020dd71aba15005375a6ae84d5d1280291999ab9a3370ea00890031199109111111198010048041bae35742a00e6eb8d5d09aba2500723333573466e1d40152004233221222222233006009008300c35742a0126eb8d5d09aba2500923333573466e1d40192002232122222223007008300d357426aae79402c8cccd5cd19b875007480008c848888888c014020c038d5d09aab9e500c23263201333573802802602202001e01c01a01801626aae7540104d55cf280189aab9e5002135573ca00226ea80048c8c8c8c8cccd5cd19b875001480088ccc888488ccc00401401000cdd69aba15004375a6ae85400cdd69aba135744a00646666ae68cdc3a80124000464244600400660106ae84d55cf280311931900619ab9c00d00c00a009135573aa00626ae8940044d55cf280089baa001232323333573466e1d400520022321223001003375c6ae84d55cf280191999ab9a3370ea004900011909118010019bae357426aae7940108c98c8024cd5ce00500480380309aab9d50011375400224464646666ae68cdc3a800a40084244400246666ae68cdc3a8012400446424446006008600c6ae84d55cf280211999ab9a3370ea00690001091100111931900519ab9c00b00a008007006135573aa00226ea80048c8cccd5cd19b8750014800884880088cccd5cd19b8750024800084880048c98c8018cd5ce00380300200189aab9d37540029309000a481035054310011232300100122330033002002001332323232332232323232332232323322323232323232323233223232323232322222325335003153355335333573466e1cccc018ccd54c05448005404d406ccc02d4cd4d54004888888888888010588854cd4004400888594004d40108888008d401088880052002021020102113357389210131000201533553353301033011333006333553015120015013501b3300b350042222004500100f00f01233007337046a008444400666e0520d00f3500522001483403c40844cd5ce2481013200020153355335333573466e1cc8cccd54c06848004c8cd408088ccd408400c004008d4078004cd407c888c00cc008004800488cdc0000a40040029000199119180099aa98088900091a800910009aa802111111111111006190009aa81391299a800880191099299a99191a801111a801911919a802919a8021299a999ab9a3371e0040020620602a00620604060466a00840604a66a666ae68cdc78010008188180a80188180a99a80190a99a8011099a801119a801119a801119a8011198190010009019919a801101991981900100091101991119a8021019911299a999ab9a3370e00c00606c06a2a66a666ae68cdc380280101b01a8999ab9a3370e00800206c06a206a206a205c2a66a0024205c205c664424660020060046424460020066aa66a6a014446a0044444444444446666a01a4a0464a0464a0464666aa606024002a04246a00244a66aa66a666ae68cdc79a801110011a8021100101d81d0999ab9a3370e6a004440026a00844002076074207426a04e0062a04c01a426a002446a00244446a0084466a0044606a93119aa81b00080289815a4c44004a0286a006444400826600e00600220026008002a034a03690010108100810899ab9c491013300020153353301033011333006333553015120015013501b3300b3500522002500100f00f01233007337046a00844440066a00a440029068078810899ab9c49101340002010201020102015335323235002222222222222533533355302712001501825335333573466e3c0380040c00bc4d40700045406c010840c040b8d40148888010d40088800840844cd5ce2481013500020135001220022223232300100532001355023223350014800088d4008894cd4ccd5cd19b8f002009025024130070011300600332001355022223350014800088d4008894cd4ccd5cd19b8f0020070240231001130060033200135501e222325335333573466e1c0080180780745854cd4ccd5cd19b8800200601e01d1330043370200c00666e040180084cc038cdc2001a80099b8400250011330040020013200135501d2225335333573466e1c00401007006c40084cc00c004cdc3001000a4000266a02844a66a004420062002a004446a002444444444444666aa603024002446a00444446a0084466a0044a66a666ae68cdc780b800816816099a81300300408041004280f0050909118010018891000990009aa80b910891299a8008a80891099a809180200119aa980309000802000a441002235002223500322333573466e20cdc100200099b8200200301601722123300100300248008488cd54c01c480048d400488cd54058008cd54c028480048d400488cd54064008ccd40048cc0612000001223301900200123301800148000004cd54c01c480048d400488cd54058008ccd40048cd54c02c480048d400488cd54068008d5403400400488ccd55402004c0080048cd54c02c480048d400488cd54068008d54030004004ccd55400c038008004444888ccd54c010480054024cd54c01c480048d400488cd54058008d54024004ccd54c0104800488d4008894cd4ccd54c03048004c8cd404888ccd400c88008008004d40048800448cc004894cd4008405c40040508d400488cc028008014018400c4cd403401000d4028004cd54c01c480048d400488c8cd5405c00cc004014c8004d5405c894cd40044d5402800c884d4008894cd4cc03000802044888cc0080280104c01800c008c8004d5404088448894cd40044008884cc014008ccd54c01c480040140100044484888c00c0104484888c004010c8004d540348844894cd40045401c884cd4020c010008cd54c01848004010004c8004d5403088448894cd40044d402000c884ccd402c014c010008ccd54c01c480040140100044488008488488cc00401000c48d40048800448d40048800848848cc00400c00888ccd5cd19b8f0020010040031220021220012233700004002464c649319ab9c4901024c67001200111221233001003002112323001001223300330020020013351223300248811c${resolvePaymentKeyHash(owner)}00480a08848cc00400c0088005`
  },
})[version];

type CreateMarketplaceOptions = {
  version: ScriptVersion;
  initiator: IInitiator;
  submitter: ISubmitter;
  owner: OwnerAddress;
  fetcher: IFetcher;
  network: Network;
  signer: ISigner;
}

type OwnerAddress = string;

type ScriptVersion = `V${1}`;
