import dotenv from "dotenv";

import { OgmiosProvider } from "@meshsdk/provider";

dotenv.config();
const apiUrl = process.env.OGMIOS_API_URL_PREPROD!;
const provider = new OgmiosProvider(apiUrl);

const successTx =
  "84a600d9010285825820499af6910ae1eedcb09f9029effd7ea81f2c9b1f1d42810b195dbc3d01e4f7b80182582061ded950e2df986e856853b2621016c9c916e8a7de0211bf3c48198ec5343e0d028258207fccfaff58a54127a6e37a8da65c7d756ebe50a638792356919077e55ef07d1d01825820985ce87f2e1e657755a7f301fd112dec2e60b02051da2578c9d6e5dedbca6bf701825820985ce87f2e1e657755a7f301fd112dec2e60b02051da2578c9d6e5dedbca6bf703018482583930bd3ae991b5aafccafe5ca70758bd36a9b2f872f57f6d3a1ffa0eb777b2f6abf60ccde92eae1a2f4fdf65f2eaf6208d872c6f0e597cc10b07821a00118f32a1581ce16c2dc8ae937e8d3790c7fd7168d7b994621ba14ca11415f39fed72a1434d494e1a004c4b408258390064a48d819b0189701800f3dc7e598d90a9d0db552555f797afd8d458d7a50f9a57c231237bb5b82eb2f74ed977a0ad021c928ca0512c62e4821b000000012ea1f189a2581c060a9fc51e3f9bbe33e27591d50be84810559488f04580fa4420d7e9a1530014df1052656772657373696f6e20746573741a00124f80581ce16c2dc8ae937e8d3790c7fd7168d7b994621ba14ca11415f39fed72a1434d494e1b00000017482a9cc082583900b57247614be75ce45c938c9b746b98ebca1a6eefd0ae50dcc1814ad8eefb0e6eb7e4085c636a14b774c32f46152e80ca29bf62148bf377521a041cdb408258390008d9d743d6ee8cbec90836b8eb7a0563698a0d2a3b154cbad9ca13467c16240714ea0e12b41a914f2945784ac494bb19573f0ca61a08afa8821ae5eaa2caa2581c060a9fc51e3f9bbe33e27591d50be84810559488f04580fa4420d7e9a1530014df1052656772657373696f6e20746573741a000186a2581c28aaa2b08ca6cb31007f6bce2a302476b0c73590d5e643c0502efe2ea147455a546f6b656e190c1b021bffffffffffffffff075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030c0b5820e5a9393365e82f189cc71b0446e9da64951f537a5ed762a685a5403c2e4c30690dd90102818258207fccfaff58a54127a6e37a8da65c7d756ebe50a638792356919077e55ef07d1d01a205a182000182d87980821a006acfc01ab2d05e0007d901028159026d59026a01010029800aba2aba1aba0aab9faab9eaab9dab9a488888896600264653001300800198041804800cdc3a400530080024888966002600460106ea800e26466453001159800980098059baa002899912cc004c00cc034dd5004c4c8c96600260280031337126eb4c04cc040dd5002192cc004c028c040dd5000c5200089bad3014301137540028078c966002601460206ea80062980103d87a8000899198008009bab30153012375400444b30010018a6103d87a8000899192cc004cdc8a45000018acc004cdc7a44100001898039980b980a80125eb82298103d87a8000404d1330040043019003404c6eb8c04c004c058005014201e32330010013756600860226ea8c050008896600200314c103d87a8000899192cc004cdc8a45000018acc004cdc7a44100001898031980b180a00125eb82298103d87a80004049133004004301800340486eb8c048004c05400501345901119198008009bac3013301430143010375401044b30010018a5eb8226644b30013375e602c60266ea8c058c04cdd500118029980a980318099baa0074bd7044cc054008cc0100100062660080080028088c050004c0540050121ba54800226466446600400400244b30010018a508acc004cdc79bae30140010038a51899801001180a800a01e40486eb0c048c04cc04cc04cc04cc04cc04cc04cc04cc03cdd50039bae3001300e37540048060c03cc030dd5001118081808800c5900a4c02cdd5003cc03c00d2225980098020014566002601e6ea802a00716404115980098040014566002601e6ea802a0071640411640348068601a601c0026e1d20003009375400716401c300800130033754011149a26cac8009f5d90103a0";
const failTx =
  "84a700848258203483fb2ced4fe3a8365e6a759a39d649b6c059bd04e8db6525dceef1fe7b2f25182c8258207702194883a5e3313a20bc7f4c52c05bd3b0d77e195be58d3976b36572774292182c82582077b196828fa17091d0ec94850c98d03bda0e6cd9e4373cdcd60a6b192f73fee9182e825820aaf165950213d80294a5e8f88aa31f6358c5e7c661071620715f4c3ce187f51c07018ea300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0016e360a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a02faf080028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0016e360a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a02faf080028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a3005839101e9d8eac318f4e362ce80b987e63b6e41740d08bb084f014ae6633a95ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0053a7e2a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a004c4b40028201d81843d87980825839001e4eb194e3335a0dcc4f5c5d009318167c583bb3b0879d9f718cd9e0d63a93470bd4d8bb986c02ff8a6043796b91cc397ceb29058f5c9ac01a20c46d08021a0003e8780b58208847a14577b0531c2a8ae0f7c27f2c75cc076c0864b3a641f5302a654c03b4cc0d818258203fbdf2b0b4213855dd9b87f7c94a50cf352ba6edfdded85ecb22cf9ceb75f814070e82581c1e4eb194e3335a0dcc4f5c5d009318167c583bb3b0879d9f718cd9e0581c5ca51b304b1f79d92eada8c58c513e969458dcd27ce4f5bc47823ffa128682582077b196828fa17091d0ec94850c98d03bda0e6cd9e4373cdcd60a6b192f73fee9182e825820aaf165950213d80294a5e8f88aa31f6358c5e7c661071620715f4c3ce187f51c078258207702194883a5e3313a20bc7f4c52c05bd3b0d77e195be58d3976b36572774292182c825820efe6fbbdd6b993d96883b96c572bfcaa0a4a138c83bd948dec1751d1bfda09b3008258203483fb2ced4fe3a8365e6a759a39d649b6c059bd04e8db6525dceef1fe7b2f25182c825820afd210b69469ebbb2997fd9285c6ae50833d82bcd817c6126ec05126fcdb6cad01a10584840000d879808219a9391a00d6d123840001d879808219a9391a00d6d123840002d879808219a9391a00d6d123840003d879808219a9391a00d6d123f5f6";

// Simple transaction CBOR for additionalTxs testing
const additionalTxCbor =
  "84a400d9010281825820985ce87f2e1e657755a7f301fd112dec2e60b02051da2578c9d6e5dedbca6bf703018282583930bd3ae991b5aafccafe5ca70758bd36a9b2f872f57f6d3a1ffa0eb777b2f6abf60ccde92eae1a2f4fdf65f2eaf6208d872c6f0e597cc10b07821a00118f32a1581ce16c2dc8ae937e8d3790c7fd7168d7b994621ba14ca11415f39fed72a1434d494e1a004c4b408258390064a48d819b0189701800f3dc7e598d90a9d0db552555f797afd8d458d7a50f9a57c231237bb5b82eb2f74ed977a0ad021c928ca0512c62e4821b000000012ea1f189a2581c060a9fc51e3f9bbe33e27591d50be84810559488f04580fa4420d7e9a1530014df1052656772657373696f6e20746573741a00124f80581ce16c2dc8ae937e8d3790c7fd7168d7b994621ba14ca11415f39fed72a1434d494e1b00000017482a9cc0021a0002b175075820bdaa99eb158414dea0a91d6c727e2268574b23efe6e08ab3b841abe8059a030ca0f5d90103a0";

describe("Ogmios Evaluator", () => {
  it("should successfully evaluate correct tx", async () => {
    const res = await provider.evaluateTx(successTx);
    expect(res.length).toBeGreaterThan(0);
  });

  it("should fail evaluating incorrect tx", async () => {
    const res = await provider.evaluateTx(failTx).catch(() => "error");
    expect(res).toBe("error");
  });

  it("should successfully evaluate tx with additionalTxs", async () => {
    const res = await provider.evaluateTx(successTx, undefined, [
      additionalTxCbor,
    ]);
    expect(res.length).toBeGreaterThan(0);
  });

  it("should fail with invalid additionalTxs CBOR", async () => {
    // Adding an invalid character 'x' at the beginning
    const invalidCbor = "x" + additionalTxCbor;
    const res = await provider
      .evaluateTx(successTx, undefined, [invalidCbor])
      .catch(() => "error");
    expect(res).toBe("error");
  });
});
