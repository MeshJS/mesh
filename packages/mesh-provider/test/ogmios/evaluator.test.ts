import dotenv from "dotenv";

import { OgmiosProvider } from "@meshsdk/provider";

dotenv.config();
const apiUrl = process.env.OGMIOS_API_URL!;
const provider = new OgmiosProvider(apiUrl);

const successTx =
  "84a70081825820859d3b4fd3a4c012b43ee1bbbc99240aec1827c3b8a74b867d10a7f4759149bc00018382583900e4cfbbc317c718f78d137b6535d8940618cc3d2ac04f1f35acf78e53a1521c2cea3cc79762d575581e47ea60b8eaa03430716cfd6140c796821a0011b0dea1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a149000643b0546573743101a300581d7067dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a113615201821a001ad510a1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a149000de140546573743101028201d8185882d8799fa4446e616d6545546573743145696d6167655835697066733a2f2f516d527a6963705265757477436b4d36616f74754b6a4572464355443231334470775071364279757a4d4a617561496d656469615479706549696d6167652f6a70674b6465736372697074696f6e5348656c6c6f20776f726c64202d20434950363802ff825839003659ed2a30abb32e97589f2a01c8500ce8fc4897b868ebe42fbf4a8aa1521c2cea3cc79762d575581e47ea60b8eaa03430716cfd6140c7961a00134249021a000c830909a1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a249000643b054657374310149000de1405465737431010b58207ae25a8a9286347cc1e0444a0de75e07432a6ed243591ef673fd837bb5235a670d82825820859d3b4fd3a4c012b43ee1bbbc99240aec1827c3b8a74b867d10a7f4759149bc00825820859d3b4fd3a4c012b43ee1bbbc99240aec1827c3b8a74b867d10a7f4759149bc050e81581ce4cfbbc317c718f78d137b6535d8940618cc3d2ac04f1f35acf78e53a206815883588101000032323232323232322232533300632323232533300a3370e9000000899b8f375c601c601000e911046d6573680014a0601000260180026018002600800429309b2b19299980319b87480000044c8c94ccc02cc03400852616375c601600260080062c60080044600a6ea80048c00cdd5000ab9a5573aaae7955cfaba157450581840100d8799f446d657368ff821a006acfc01ab2d05e00f5f6";
const failTx =
  "84a700848258203483fb2ced4fe3a8365e6a759a39d649b6c059bd04e8db6525dceef1fe7b2f25182c8258207702194883a5e3313a20bc7f4c52c05bd3b0d77e195be58d3976b36572774292182c82582077b196828fa17091d0ec94850c98d03bda0e6cd9e4373cdcd60a6b192f73fee9182e825820aaf165950213d80294a5e8f88aa31f6358c5e7c661071620715f4c3ce187f51c07018ea300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0016e360a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a02faf080028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0016e360a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a02faf080028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a300583910cb55816770a83383463164b8b28609cefb26e73b2a7d361c3194b5335ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb011a004c4b40028201d81843d87980a3005839101e9d8eac318f4e362ce80b987e63b6e41740d08bb084f014ae6633a95ca749261aa3b17aa2cd4b026bc6566c4b14421d6083edce64ffe5cb01821a0053a7e2a1581c5066154a102ee037390c5236f78db23239b49c5748d3d349f3ccf04ba144555344581a004c4b40028201d81843d87980825839001e4eb194e3335a0dcc4f5c5d009318167c583bb3b0879d9f718cd9e0d63a93470bd4d8bb986c02ff8a6043796b91cc397ceb29058f5c9ac01a20c46d08021a0003e8780b58208847a14577b0531c2a8ae0f7c27f2c75cc076c0864b3a641f5302a654c03b4cc0d818258203fbdf2b0b4213855dd9b87f7c94a50cf352ba6edfdded85ecb22cf9ceb75f814070e82581c1e4eb194e3335a0dcc4f5c5d009318167c583bb3b0879d9f718cd9e0581c5ca51b304b1f79d92eada8c58c513e969458dcd27ce4f5bc47823ffa128682582077b196828fa17091d0ec94850c98d03bda0e6cd9e4373cdcd60a6b192f73fee9182e825820aaf165950213d80294a5e8f88aa31f6358c5e7c661071620715f4c3ce187f51c078258207702194883a5e3313a20bc7f4c52c05bd3b0d77e195be58d3976b36572774292182c825820efe6fbbdd6b993d96883b96c572bfcaa0a4a138c83bd948dec1751d1bfda09b3008258203483fb2ced4fe3a8365e6a759a39d649b6c059bd04e8db6525dceef1fe7b2f25182c825820afd210b69469ebbb2997fd9285c6ae50833d82bcd817c6126ec05126fcdb6cad01a10584840000d879808219a9391a00d6d123840001d879808219a9391a00d6d123840002d879808219a9391a00d6d123840003d879808219a9391a00d6d123f5f6";

const chainedSuccessTx =
  "84a700818258208aecae827277c5da5f5d0e267f4ec0d15d2aeaa51d30b653fb46535e2483d7bb00018382583900e4cfbbc317c718f78d137b6535d8940618cc3d2ac04f1f35acf78e53a1521c2cea3cc79762d575581e47ea60b8eaa03430716cfd6140c796821a0011b0dea1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a149000643b0546573743101a300581d7067dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a113615201821a001ad510a1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a149000de140546573743101028201d8185882d8799fa4446e616d6545546573743145696d6167655835697066733a2f2f516d527a6963705265757477436b4d36616f74754b6a4572464355443231334470775071364279757a4d4a617561496d656469615479706549696d6167652f6a70674b6465736372697074696f6e5348656c6c6f20776f726c64202d20434950363802ff825839003659ed2a30abb32e97589f2a01c8500ce8fc4897b868ebe42fbf4a8aa1521c2cea3cc79762d575581e47ea60b8eaa03430716cfd6140c7961a00134249021a000c830909a1581c67dd133868f14107b25772f3c5abaa1e0549f4b400b5e0e3a1136152a249000643b054657374310149000de1405465737431010b58207ae25a8a9286347cc1e0444a0de75e07432a6ed243591ef673fd837bb5235a670d82825820859d3b4fd3a4c012b43ee1bbbc99240aec1827c3b8a74b867d10a7f4759149bc00825820859d3b4fd3a4c012b43ee1bbbc99240aec1827c3b8a74b867d10a7f4759149bc050e81581ce4cfbbc317c718f78d137b6535d8940618cc3d2ac04f1f35acf78e53a206815883588101000032323232323232322232533300632323232533300a3370e9000000899b8f375c601c601000e911046d6573680014a0601000260180026018002600800429309b2b19299980319b87480000044c8c94ccc02cc03400852616375c601600260080062c60080044600a6ea80048c00cdd5000ab9a5573aaae7955cfaba157450581840100d8799f446d657368ff821a006acfc01ab2d05e00f5f6";

describe("Ogmios Evaluator", () => {
  it("should successfully evaluate correct tx", async () => {
    const res = await provider.evaluateTx(successTx);
    expect(res.length).toBeGreaterThan(0);
  });

  it("should fail evaluating incorrect tx", async () => {
    const res = await provider.evaluateTx(failTx).catch(() => "error");
    expect(res).toBe("error");
  });

  it("should successfully evaluate tx with additionalTxs", async () => {
    const res = await provider.evaluateTx(chainedSuccessTx, [
      {
        input: {
          txHash:
            "8aecae827277c5da5f5d0e267f4ec0d15d2aeaa51d30b653fb46535e2483d7bb",
          outputIndex: 0,
        },
        output: {
          address:
            "addr_test1qrjvlw7rzlr33audzdak2dwcjsrp3npa9tqy78e44nmcu5ap2gwze63uc7tk94t4tq0y06nqhr42qdpsw9k06c2qc7tqzjkxjr",
          amount: [{ unit: "lovelace", quantity: "5000000" }],
        },
      },
    ]);
    expect(res.length).toBeGreaterThan(0);
  });

  it("should fail with invalid additionalTxs CBOR", async () => {
    const res = await provider
      .evaluateTx(chainedSuccessTx, [])
      .catch(() => "error");
    expect(res).toBe("error");
  });
});
